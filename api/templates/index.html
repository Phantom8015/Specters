<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="../static/icon.svg"
      sizes="any"
      type="image/svg+xml"
    />
    <style>
      * {
        user-select: none;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        transition:
          background 0.5s,
          color 0.5s;
      }

      .coolfont {
        font-family: Georgia, sans-serif;
        background: linear-gradient(
          90deg,
          rgb(237, 153, 153),
          rgb(241, 199, 144),
          rgb(246, 241, 144),
          rgb(240, 177, 117)
        );
        background-size: 300% 300%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: balls 3s ease-in-out infinite;
      }
      @keyframes balls {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        background:
          radial-gradient(
            circle at 15% 25%,
            rgba(138, 95, 30, 0.3) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 85% 15%,
            rgba(235, 37, 37, 0.2) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 45% 75%,
            rgba(216, 113, 29, 0.25) 0%,
            transparent 45%
          ),
          radial-gradient(
            circle at 75% 85%,
            rgba(175, 158, 30, 0.2) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 25% 65%,
            rgba(246, 59, 59, 0.15) 0%,
            transparent 35%
          ),
          linear-gradient(135deg, #000 0%, #190f0f 50%, #140c00 100%);
        background-size: 400% 400%;
        animation: balls 60s ease-in-out infinite;
        color: white;

        font-size: 13px;
      }

      .carousel {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        gap: 1.25rem;
        padding: 1.25rem 0;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
      }
      .carousel::-webkit-scrollbar {
        height: 6px;
      }
      .carousel::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .course-card {
        min-width: 270px;
        scroll-snap-align: start;
        cursor: pointer;
        position: relative;
        border-radius: 0.75rem;
        overflow: hidden;
        transition: transform 0.3s ease;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
      }

      body {
        --card-bg: rgba(0, 0, 0, 0.2);
        --card-border: rgba(255, 255, 255, 0.05);
        --text-muted: rgba(255, 255, 255, 0.6);
      }

      .progress-container {
        height: 6px;
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(
          90deg,
          rgb(237, 153, 153),
          rgb(241, 199, 144),
          rgb(246, 241, 144),
          rgb(240, 177, 117)
        );
        transition: width 0.4s ease;
      }

      .fade {
        opacity: 0;
        transition: opacity 0.6s ease;
      }
      .fade.show {
        opacity: 1;
      }
      #userSection {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        padding: 1rem 1.5rem;
        z-index: 50;
      }
    </style>
  </head>

  <body class="dark">
    <div
      id="main_content"
      class="flex items-center justify-center h-screen flex-col"
    >
      <h1 class="text-4xl justify-center mb-12 coolfont backdrop-blur-xl">
        Specters
      </h1>

      <div id="authSection" class="w-3/4 max-w-3xl mb-8 hidden">
        <button
          id="loginBtn"
          class="w-full border-white/[0.05] shadow-inner shadow-black/[0.5] hover:shadow-md hover:shadow-black/[0.3] border bg-black/[0.1] backdrop-blur-lg text-white/[0.8] hover:text-black rounded-full py-4 px-8 transition-all duration-300 ease-in-out text-base relative overflow-hidden group"
        >
          <span
            class="absolute inset-0 bg-gradient-to-r from-[rgb(237,153,153)] via-[rgb(241,199,144)] to-[rgb(240,177,117)] opacity-0 group-hover:opacity-100 transition-opacity duration-300 ease-in-out"
          ></span>
          <span class="relative z-10"
            ><i class="fab fa-google mr-2"></i> Sign in with Google</span
          >
        </button>
      </div>

      <textarea
        placeholder="What do you wanna learn?"
        id="input"
        class="p-5 sticky bg-black/[0.1] resize-none text-base outline-none backdrop-blur-xl transition-shadow duration-200 ease-in-out shadow-sm focus:shadow-lg text-white/[0.8] placeholder-white/[0.4] border border-white/[0.05] rounded-full h-18 w-3/4 max-w-3xl"
      ></textarea>

      <div id="continueCarousel" class="w-3/4 max-w-3xl mt-10 hidden fade">
        <h3 class="text-white/[0.6] text-sm mb-4 uppercase tracking-wider">
          Continue Learning
        </h3>
        <div class="carousel" id="continueList"></div>
      </div>

      <div class="carousel" id="coursesList"></div>
    </div>

    <div id="userSection" class="flex flex-col items-start space-y-4">
      <div
        class="flex items-center justify-between bg-black/[0.1] backdrop-blur-xl border border-white/[0.05] rounded-full py-3 px-6 w-full"
      >
        <div class="flex items-center">
          <img id="userPicture" src="" class="w-10 h-10 rounded-full mr-3" />
          <span id="userName" class="text-white/[0.8] text-base"></span>
        </div>
        <button
          id="logoutBtn"
          class="bg-red-500/[0.1] hover:bg-red-500/[0.5] border border-red-500/[0.1] text-white rounded-full py-1.5 px-4 text-sm transition duration-300"
        >
          <i class="fa fa-sign-out-alt mr-1"></i>
        </button>
      </div>
    </div>

    <script>
      const continueList = document.getElementById("continueList");
      const continueCarousel = document.getElementById("continueCarousel");

      let currentUser = null;

      async function checkAuth() {
        try {
          const res = await fetch("/api/user");
          const data = await res.json();

          if (data.logged_in) {
            currentUser = data;
            document.getElementById("authSection").classList.add("hidden");
            document.getElementById("userSection").classList.remove("hidden");
            document.getElementById("userName").textContent = data.name;
            document.getElementById("userPicture").src = data.picture;
            document.getElementById("input").disabled = false;
          } else {
            document.getElementById("authSection").classList.remove("hidden");
            document.getElementById("userSection").classList.add("hidden");
            document.getElementById("input").disabled = true;
            document.getElementById("input").placeholder =
              "Sign in to start learning";
          }
        } catch (err) {
          console.error("Auth check failed:", err);
        }
      }

      function deleteCourse(courseId) {
        if (!confirm("Are you sure you want to delete this course?")) return;

        fetch(`/api/course/${courseId}`, { method: "DELETE" })
          .then((res) => res.json())
          .then(() => {
            const card = document.getElementById(`course-${courseId}`);
            if (card) {
              card.style.transition = "all 0.3s ease";
              card.style.opacity = 0;
              card.style.transform = "scale(0.9)";
              setTimeout(() => card.remove(), 300);

              const label = document.getElementById("courseCountLabel");
              if (label) label.textContent = parseInt(label.textContent) - 1;
            }
          })
          .catch((err) => console.error(err));
      }

      async function loadContinueCourses() {
        try {
          const res = await fetch("/api/user/courses");
          const data = await res.json();

          if (!data.courses?.length) {
            continueCarousel.classList.add("hidden");
            return;
          }

          const coursesWithProgress = await Promise.all(
            data.courses.map(async (c) => {
              const progress = await fetch(`/api/course/${c.id}/progress`)
                .then((r) => r.json())
                .then((p) => p.progress?.percent || 0)
                .catch(() => 0);

              return { ...c, progress };
            }),
          );

          continueList.innerHTML = coursesWithProgress
            .map((c) => {
              const title =
                c.title.length > 30 ? c.title.slice(0, 30) + "..." : c.title;
              return `
              <div class="course-card p-5 relative" id="course-${c.id}">
                <button 
                  onclick="event.stopPropagation(); deleteCourse('${c.id}')"
                  class="absolute top-3 right-3 w-6 h-6 flex items-center justify-center text-white/[0.4] hover:text-red-500 hover:bg-red-500/[0.1] rounded-full transition-all duration-200 z-10"
                  title="Delete course"
                >
                  <i class="fa fa-times text-sm"></i>
                </button>
                <div onclick="window.location.href='/course?id=${c.id}'" class="cursor-pointer">
                  <h4 class="text-base font-semibold mb-2 pr-6">${title}</h4>
                  <div class="flex justify-between items-center text-sm text-[var(--text-muted)] mb-1">
                    <span>${c.progress}% complete</span>
                    <span>${new Date(c.created_at).toLocaleDateString()}</span>
                  </div>
                  <div class="progress-container">
                    <div class="progress-bar" style="width:${c.progress}%"></div>
                  </div>
                </div>
              </div>`;
            })
            .join("");

          continueCarousel.classList.remove("hidden");
          continueCarousel.classList.add("show");
        } catch (err) {
          console.error("Failed to load continue courses", err);
        }
      }

      loadContinueCourses();
      document
        .getElementById("loginBtn")
        .addEventListener("click", () => (window.location.href = "/login"));
      document
        .getElementById("logoutBtn")
        .addEventListener("click", () => (window.location.href = "/logout"));

      const textarea = document.getElementById("input");
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (window.innerWidth <= 768) return;
          const content = textarea.value.trim();
          if (!content || !currentUser) return;
          window.location.href = `/course?prompt=${encodeURIComponent(content)}`;
        }
      });

      if (window.innerWidth <= 768) {
        const input = document.getElementById("input");
        input.disabled = true;
        input.placeholder = "Unusable on mobile.";
      }

      checkAuth();
    </script>
  </body>
</html>
